<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SettlementAI | Risk Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Status Colors */
        .status-ACSC { color: #10b981; font-weight: 700; } /* Success Green */
        .status-PENF { color: #ef4444; font-weight: 700; } /* Fail Red */
        
        /* Badges */
        .badge { 
            font-size: 0.7rem; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-weight: 600; 
            letter-spacing: 0.05em; 
            display: inline-block;
        }
        
        /* Credit Score Colors */
        .bg-credit-high { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; } /* 700+ */
        .bg-credit-mid { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }  /* 600-700 */
        .bg-credit-low { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }   /* <600 */
        
        /* Animations */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .live-indicator { animation: pulse-green 2s infinite; }
        
        tr { transition: background-color 0.2s; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <nav class="bg-slate-900 text-white shadow-lg border-b border-blue-500 sticky top-0 z-50">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 bg-blue-600 rounded flex items-center justify-center font-bold text-lg">AI</div>
                <div>
                    <h1 class="text-lg font-bold tracking-tight">Settlement<span class="text-blue-400">Core</span> Engine</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest">T+1 Predictive Risk System</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <div id="last-update" class="text-[10px] text-slate-400 font-mono">Status: Active</div>
                    <div class="flex items-center justify-end gap-1">
                        <div class="w-2 h-2 bg-green-500 rounded-full live-indicator"></div>
                        <span class="text-xs font-bold text-green-400">SYSTEM ONLINE</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="bg-white border-b border-slate-200 shadow-sm sticky top-16 z-40">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="text-xs uppercase font-bold text-slate-400 tracking-wider">Simulation Time</div>
                <div id="sim-clock" class="text-xl font-mono font-bold text-blue-600 bg-blue-50 px-4 py-1 rounded border border-blue-100 shadow-inner">
                    Initializing...
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="resetSimulation()" class="text-xs font-bold text-slate-500 hover:text-slate-700 px-3 py-2 border border-transparent hover:border-slate-300 rounded transition-all">
                    ‚Ü∫ Reset
                </button>
                <button onclick="advanceTime()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-4 py-2 rounded shadow transition-colors flex items-center gap-2">
                    <span>‚ñ∂ Advance 1 Hour</span>
                </button>
                <button onclick="toggleAutoPlay()" id="btn-auto" class="bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-bold px-4 py-2 rounded shadow transition-colors border border-emerald-600">
                    <span>‚ö° Auto-Play</span>
                </button>
            </div>
        </div>
    </div>

    <main class="container mx-auto py-8 px-4">
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-red-500 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-10 text-red-500">
                    <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                </div>
                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1 tracking-wider">Predicted Fail Rate (T+1)</p>
                <div class="flex items-end justify-between relative z-10">
                    <h2 id="fail-rate" class="text-3xl font-bold text-slate-800">0.0%</h2>
                    <span class="text-xs text-red-500 font-bold mb-1 bg-red-50 px-1 rounded">High Alert</span>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-blue-500 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-10 text-blue-500">
                    <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"></path><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"></path></svg>
                </div>
                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1 tracking-wider">Avg Counterparty Credit</p>
                <div class="flex items-end justify-between relative z-10">
                    <h2 id="avg-credit" class="text-3xl font-bold text-slate-800">---</h2>
                    <span class="text-[10px] text-slate-400 mb-1">FICO Scale (300-850)</span>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-purple-500">
                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1 tracking-wider">Market Stress (VIX Factor)</p>
                <div class="flex items-end justify-between">
                    <h2 id="vix-factor" class="text-3xl font-bold text-slate-800">1.00x</h2>
                    <div class="w-24">
                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden mb-1">
                            <div id="vix-bar" class="h-full bg-purple-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div class="text-[10px] text-right text-slate-400">Systemic Load</div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-emerald-500">
                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1 tracking-wider">Hourly Volume</p>
                <h2 id="total-vol" class="text-3xl font-bold text-slate-800">0</h2>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-slate-700 uppercase text-xs tracking-widest flex items-center gap-2">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    Live Trade Feed (Last 50 Entries)
                </h3>
                <div class="flex gap-2">
                    <span class="text-[10px] px-2 py-1 rounded bg-blue-100 text-blue-700 font-bold border border-blue-200">XGBoost Ready</span>
                    <span class="text-[10px] px-2 py-1 rounded bg-purple-100 text-purple-700 font-bold border border-purple-200">LSTM Time-Series</span>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-slate-400 text-[10px] uppercase bg-slate-50 border-b border-slate-200">
                            <th class="p-4 font-bold tracking-wider">Time (UTC)</th>
                            <th class="p-4 font-bold tracking-wider">Counterparty (Credit)</th>
                            <th class="p-4 font-bold tracking-wider">Asset / Liquidity</th>
                            <th class="p-4 font-bold tracking-wider text-right">Amount (USD)</th>
                            <th class="p-4 font-bold tracking-wider">AI Risk Factors</th>
                            <th class="p-4 font-bold tracking-wider text-right">Prediction</th>
                        </tr>
                    </thead>
                    <tbody id="trade-body" class="text-sm divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>
            <div class="p-3 bg-slate-50 border-t border-slate-200 text-center text-xs text-slate-400 font-mono">
                End of Live Feed
            </div>
        </div>
    </main>

    <script>
        let allTrades = [];      // Stores the full 10,000 trades
        let currentSimTime = null; // The current "virtual" time
        let autoPlayInterval = null;
        let SimEndTime = null;

        // 1. Initialize System
        async function initSystem() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) throw new Error("Failed to load data.json");
                
                allTrades = await response.json();
                
                // Sort by time just in case
                allTrades.sort((a, b) => new Date(a.PreparationDateTime) - new Date(b.PreparationDateTime));

                // Set Start Time (First trade timestamp - 1 hour)
                if (allTrades.length > 0) {
                    const firstDate = new Date(allTrades[0].PreparationDateTime);
                    // Start exactly at the hour of the first trade
                    firstDate.setMinutes(0);
                    firstDate.setSeconds(0);
                    currentSimTime = firstDate;
                    
                    const lastDate = new Date(allTrades[allTrades.length - 1].PreparationDateTime);
                    SimEndTime = lastDate;
                }

                updateDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('sim-clock').innerText = "DATA ERROR";
                document.getElementById('sim-clock').classList.add("text-red-600");
            }
        }

        // 2. Core Update Logic
        function updateDashboard() {
            if (!currentSimTime) return;

            // Filter: Only show trades that happened BEFORE currentSimTime
            const visibleTrades = allTrades.filter(t => new Date(t.PreparationDateTime) <= currentSimTime);
            
            // --- Update Clock Display ---
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('sim-clock').innerText = currentSimTime.toLocaleTimeString('en-US', options);

            // --- Update KPIs (Based only on visible trades) ---
            const fails = visibleTrades.filter(t => t.Status === 'PENF').length;
            const failRate = visibleTrades.length > 0 ? ((fails / visibleTrades.length) * 100).toFixed(1) : "0.0";
            document.getElementById('fail-rate').innerText = failRate + "%";
            
            const totalVol = visibleTrades.length.toLocaleString();
            document.getElementById('total-vol').innerText = totalVol;

            // VIX & Credit (Take the most recent visible trade)
            if (visibleTrades.length > 0) {
                const latest = visibleTrades[visibleTrades.length - 1];
                document.getElementById('vix-factor').innerText = latest.Market_Volatility_Factor.toFixed(2) + "x";
                document.getElementById('vix-bar').style.width = Math.min((latest.Market_Volatility_Factor * 50), 100) + "%";
                
                // Avg Credit Score
                const totalCredit = visibleTrades.reduce((sum, t) => sum + t.Counterparty_Credit_Score, 0);
                const avgCredit = Math.round(totalCredit / visibleTrades.length);
                document.getElementById('avg-credit').innerText = avgCredit;
            }

            // --- Render Table (Show last 20 of VISIBLE trades for performance) ---
            const body = document.getElementById('trade-body');
            body.innerHTML = '';
            
            // Slice last 20 trades and REVERSE them so newest is on top
            const recentTrades = visibleTrades.slice(-20).reverse(); 

            if (recentTrades.length === 0) {
                body.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-400 italic">Waiting for market open...</td></tr>`;
            }

            recentTrades.forEach(trade => {
                let creditClass = 'bg-credit-high';
                if (trade.Counterparty_Credit_Score < 700) creditClass = 'bg-credit-mid';
                if (trade.Counterparty_Credit_Score < 600) creditClass = 'bg-credit-low';

                const liqPercent = trade.Asset_Liquidity_Score * 100;
                const dateObj = new Date(trade.PreparationDateTime);
                const timeStr = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                const row = `
                    <tr class="hover:bg-blue-50/50 group border-b border-slate-50 transition-colors">
                        <td class="p-4">
                            <div class="font-mono text-xs font-bold text-slate-600 group-hover:text-blue-600">${timeStr}</div>
                        </td>
                        <td class="p-4">
                            <div class="font-bold text-slate-700 text-sm">${trade.Counterparty}</div>
                            <span class="badge ${creditClass} mt-1">Credit: ${trade.Counterparty_Credit_Score}</span>
                        </td>
                        <td class="p-4">
                            <div class="font-mono text-xs font-bold text-slate-600">${trade.Asset_ISIN}</div>
                            <div class="w-20 h-1.5 bg-slate-100 rounded-full mt-1 overflow-hidden">
                                <div class="h-full bg-blue-500" style="width: ${liqPercent}%"></div>
                            </div>
                            <div class="text-[10px] text-slate-400 mt-0.5">${trade.Asset_Class}</div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="font-mono text-sm text-slate-700 font-semibold">$${trade.SettlementAmount.toLocaleString()}</div>
                            <div class="text-[10px] uppercase font-bold text-slate-400">${trade.Direction}</div>
                        </td>
                         <td class="p-4">
                            <div class="flex gap-1 flex-wrap">
                                ${trade.Time_of_Day_Flag === 'Near_Cutoff' 
                                    ? '<span class="badge bg-orange-50 text-orange-600 border border-orange-200">‚è∞ Late</span>' 
                                    : ''}
                                ${trade.Asset_Liquidity_Score < 0.4 
                                    ? '<span class="badge bg-purple-50 text-purple-600 border border-purple-200">üíß Illiquid</span>' 
                                    : ''}
                            </div>
                        </td>
                        <td class="p-4 text-right">
                            <span class="status-${trade.Status} text-sm">${trade.Status}</span>
                            <div class="text-[10px] font-bold text-red-400">${trade.ISO_ReasonCode || ''}</div>
                        </td>
                    </tr>
                `;
                body.innerHTML += row;
            });
        }

        // 3. User Controls
        function advanceTime() {
            if (!currentSimTime) return;
            // Add 1 Hour
            currentSimTime.setHours(currentSimTime.getHours() + 1);
            
            // Loop back or Stop
            if (SimEndTime && currentSimTime > SimEndTime) {
                // Optional: Stop AutoPlay if we hit the end
                if (autoPlayInterval) toggleAutoPlay();
                alert("End of Simulation Data Reached.");
                return;
            }
            updateDashboard();
        }

        function toggleAutoPlay() {
            const btn = document.getElementById('btn-auto');
            if (autoPlayInterval) {
                // Stop
                clearInterval(autoPlayInterval);
                autoPlayInterval = null;
                btn.classList.remove('animate-pulse', 'bg-red-500', 'border-red-600', 'hover:bg-red-600');
                btn.classList.add('bg-emerald-500', 'hover:bg-emerald-600', 'border-emerald-600');
                btn.innerHTML = "<span>‚ö° Auto-Play</span>";
            } else {
                // Start
                advanceTime(); // Advance one immediately
                autoPlayInterval = setInterval(advanceTime, 1000); // Advance every 1 second
                
                // Change Button Styling
                btn.classList.remove('bg-emerald-500', 'hover:bg-emerald-600', 'border-emerald-600');
                btn.classList.add('animate-pulse', 'bg-red-500', 'border-red-600', 'hover:bg-red-600');
                btn.innerHTML = "<span>‚è∏ Pause Simulation</span>";
            }
        }

        function resetSimulation() {
            location.reload();
        }

        // Start System
        initSystem();
    </script>
</body>
</html>